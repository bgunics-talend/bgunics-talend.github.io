<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="referrer" content="same-origin">
	<title>CI Log Parser</title>
</head>
<body>
	<div id="results">
		Try Me! :)
	</div>
	<button onclick="doParse()" value="Parse">Parse!</button><br/>
	<br/>
	Logs to be Parsed<br/>
<textarea id=CILog  rows="50" cols="150" ></textarea>

<script type="text/javascript">
	function parseStuff(line,stuff){
		return line.substring(line.lastIndexOf(stuff)+stuff.length);
	}
	function doParse(){
		console.log(document.getElementById("results").innerHTML);
		document.getElementById("results").innerHTML = "<h4>Suggestions :)</h4>\
		<div id='suggestions'> \
			<div id='suggestions.patch1'></div> \
			<div id='suggestions.patch2'></div> <br/>\
			<div id='suggestions.gtk3'></div> <br/>\
			<div id='suggestions.assembly'></div> <br/>\
		</div> \
		<br/> \
		Consider using the Modules view in studio and customize the MVN URI for the lower version to avoid conflicts. <br/> \
		<textarea id='results.dependencies' rows='5' cols='50' > \
		</textarea> <br/>\
		Missing jars: If these are from org.talend.libraries then they could be related to custom jars (routine / tLibraryLoad) and should be in Nexus, you can also try and override them in the Modules view. <br/> \
		<textarea id='results.missingjar' rows='5' cols='50' > \
		</textarea> \
		<div id='results.info'> \
			<h4>System Information</h4> \
			<b>Proxy</b><br/> \
			<div id='results.info.proxy'></div> \
			<b>Java</b><br/> \
			<div id='results.info.java'></div> \
			<b>Other</b><br/> \
			<div id='results.info.other'></div> \
			<b>M2 repository</b><br/> \
			This should apper in the studio maven_user_settings, and is populated automatically or from global settings or sometimes $M2_HOME All the values should be the same!<br/>\
			<div id='results.info.m2repo'></div> \
		</div> \
		<h4>Other things from the logs</h4> \
		<div id='results.fatal'><b>fatal errors</b><br/></div>\
		<div id='results.exception'><b>Exceptions</b><br/></div>\
		<div id='results.error'><b>errors</b><br/></div>\
		";
		var log = document.getElementById("CILog").value
		//for(def line : log.split('\n')) 
		log.split('\n').forEach((line) => {
			var br="<br/>"
			var skip = false
		/*Known Symptoms :) */			
			if(!line.includes(':generateAllPoms') && (line.includes('7.3.1:generate') ) ){
				document.getElementById("suggestions.patch1").innerHTML = "Consider applying the Patch via -Dpatch.path"
			}
			if(!line.includes(':generateAllPoms') && (line.includes('8.0.1:generate') )) {
				document.getElementById("suggestions.patch1").innerHTML = "Consider applying the Patch via -Dtalend.studio.p2.update="	
			}

			if(!line.includes(':generateAllPoms') && (
				 line.includes('7.3.1:generate') || line.includes('7.3.2:generate') || line.includes('7.3.3:generate') ||
			 	line.includes('7.3.4:generate') || line.includes('7.3.5:generate') || line.includes('7.3.6:generate') ||
			 	line.includes('7.3.7:generate') ||
			 	line.includes('8.0.1:generate') //|| line.includes('8.0.2:generate') 
			 	)) {
				document.getElementById("suggestions.patch2").innerHTML = "Not running the latest patch!"
			}
			if(line.includes('assembly.xml does not exist') ){
				document.getElementById("suggestions.assembly").innerHTML = "Assembly.xml is generated by the studio. Likely a corrupt installation, consider reinstall studio.!"
			}
			if(line.includes('on project code.Master: Can not find equinox launcher!')) {
				document.getElementById("suggestions").innerHTML += 'Check Java Version, try to reinstall with -DforceUpdate=true -Dinstaller.clean=true'+br
			}
			if(line.includes('.eclipseproduct (The system cannot find the path specified)')) {
				document.getElementById("suggestions").innerHTML += 'P2 Repository is not correct / can\'t be accessed, hence commandline can\'t be installed'+br
			}

			if(line.includes('org.talend.components.') && line.includes('is not found')) {
				document.getElementById("suggestions").innerHTML += 'Some components were not installed correctly, consider reinstall studio, likely a problem with maven_user_settings / localRepository -> ' + parseStuff(line, 'org.talend.components.') + br;
			}
			if(line.includes('Cannot invoke method checkParameters() on null object')) {
				document.getElementById("suggestions").innerHTML += 'Is talend_jenkins_helper.groovy available under Managed Files?'+br
			}
			if(line.includes('is duplicated in the reactor')) {
				document.getElementById("suggestions").innerHTML += 'Duplicate Items in reactor:<a href="https://help.talend.com/r/en-US/Cloud/studio-user-guide-api-services-platform/removing-old-versions-of-project-items"> Try to do a Cleanup</a>'+br
			}
			if(line.includes('Could not load SWT library.')) {
				document.getElementById("suggestions.gtk3").innerHTML += 'Could not load SWT library. This should be provided by the GTK package. Please install the gtk3 libraries via: `yum install gtk3*` then reinstall commandline/studio ( -DforceUpdate=true  -Dinstaller.clean=true )'+br
			}
		/*Skip the misleading lines*/
			if(line.trim().endsWith('.class') || line.trim().endsWith('.java')) skip=true;


		/*Skip the Misleading errors */
			//00:25:50,299 [ERROR] [Fatal Error] :1:1: Content is not allowed in prolog.
			if(line.includes('[ERROR] [Fatal Error]') && line.includes('Content is not allowed in prolog.')) skip = true;
			//00:25:50,648 [ERROR] [Fatal Error] :1:2: The markup in the document preceding the root element must be well-formed.
			if(line.includes('[ERROR] [Fatal Error]') && line.includes('The markup in the document preceding the root element must be well-formed.')) skip = true;

			if(line.includes('org.talend.commons.exception.CommonExceptionHandler') && line.includes('Missing module group definition')) skip = true;
			//00:08:39,095 [DEBUG] Imported: org.codehaus.plexus.util.xml.pull.XmlPullParserException < maven.ext
			if(line.includes('[DEBUG] Imported: org.codehaus.plexus.util.xml.pull.XmlPullParserException')) skip=true;
			if(line.includes('org.talend.commons.utils.network.TalendProxySelector:')) {
				skip=true;
				document.getElementById("results.info.proxy").innerHTML = parseStuff(line, 'org.talend.commons.utils.network.TalendProxySelector:')
			}
			if(line.includes('[ERROR] SLF4J: ')) {skip = true;}
			if(line.includes('[ERROR] WARNING: ')) {skip = true;}
			if(line.includes('[ERROR] Picked up JAVA_TOOL_OPTIONS:')) {skip=true;}

		/*Parse Useful info*/
			if(line.includes('OS name:') || line.includes('Default locale:') || line.includes('Java version:') || 
				line.includes('Maven home:') || line.includes('Apache Maven')
				) {
				document.getElementById("results.info.other").innerHTML+= line+br;	
			}

			if(line.includes('Using local repository at ') ){
				var res = parseStuff(line,'Using local repository at ');
				document.getElementById('results.info.m2repo').innerHTML += 'localRepository as per Maven:' +res+br;
			}
			if(line.includes('EnhancedLocalRepositoryManager')){
				var res = parseStuff(parseStuff(line,'EnhancedLocalRepositoryManager'),'for ');
				document.getElementById('results.info.m2repo').innerHTML += 'localRepository as per Maven:'+res + ' (EnhancedLocalRepositoryManager)' + br ;
			}
			if(line.includes('maven.local.repository=')) {
				var res = parseStuff(line,'maven.local.repository=')
				res = res.substring(0,res.indexOf(' '))
				document.getElementById('results.info.m2repo').innerHTML += 'localRepository as per studio: ' + res + br;
			}

		/*Parse Dependencies*/
			//'dependencies.dependency.(groupId:artifactId:type:classifier)' must be unique:
			if(line.includes('dependencies.dependency.(groupId:artifactId:type:classifier)')) {
				document.getElementById("results.dependencies").value += parseStuff(line,'must be unique:')	+'\n';
				skip = true;
			}
			if(line.includes('org.talend.commons.exception.CommonExceptionHandler')&&line.includes('missing jar:')){
				document.getElementById('results.missingjar').value += parseStuff(line,'missing jar:')+'\n';
				skip = true;
			}
			if(line.includes('The following artifacts could not be resolved:')){
				document.getElementById('results.missingjar').value += parseStuff(line,'The following artifacts could not be resolved:')+'\n';
				skip = true;
			}
			

		/*Parse the remaining*/
		  if(!skip) {
			if(line.includes("[ERROR]") ) {
				document.getElementById("results.error").innerHTML += line+br;
			}
			if(line.includes("[FATAL]") ) {
				document.getElementById("results.fatal").innerHTML += line+br;
			}
			if(line.includes("Exception") ) {
				document.getElementById("results.exception").innerHTML += line+br;
			}
		  }
		})
	}
</script>
</body>
</html>
